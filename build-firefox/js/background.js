/*!

=========================================================
* Chong Lua Dao
=========================================================

* Product Page: https://chongluadao.vn/
* Copyright 2021 https://chongluadao.vn/
* Coded by ChongLuaDao

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

*/
!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t){window.isWhiteList={},window.isBlocked={},window.results={},window.isPhish={},window.legitimatePercents={};let n=[];const r=[];let i=!1;const s=e=>{browser.storage.local.get(["cache","cacheTime"],t=>{if(t.cache&&t.cacheTime)return e(t.cache);(e=>{fetch("https://api.chongluadao.vn/classifier.json").then(e=>e.json()).then(t=>{browser.storage.local.set({cache:t,cacheTime:Date.now()},()=>e(t))})})(e)})},o=(e,t,n)=>{if(window.isWhiteList[e]==n)return;let r=0,i=0,o=0;for(const e in t)"1"==t[e]?o++:"0"==t[e]?i++:r++;if(window.legitimatePercents[e]=r/(o+i+r)*100,t.length){const n=[t.map(e=>parseInt(e))];s((function(t){const r=(e=>({predict:t=>{let n=[e.estimators.map(e=>(e=>{const t=t=>{let n=e;for(;"split"==n.type;){const e=n.threshold.split(" <= ");n=t[e[0]]<=e[1]?n.left:n.right}return n.value[0]};return{predict:e=>e.map(e=>t(e)),predictOne:t}})(e).predict(t))];n=n[0].map((e,t)=>n.map(e=>e[t]));const r=[];for(const e in n){let t=0,i=0;for(const r in n[e])t+=n[e][r][1],i+=n[e][r][0];r.push([t>=i,Math.max(t,i)])}return r}}))(t);window.isPhish[e]=r.predict(n)[0][0],window.isPhish[e]&&window.legitimatePercents[e]>60&&(window.isPhish[e]=!1),d(window.isPhish[e],window.legitimatePercents[e],e)}))}},a=()=>{fetch("https://api.chongluadao.vn/v1/blacklist").then(e=>e.json()).then(e=>{e.forEach(e=>{n.push(e.url)})}).catch(()=>{}),fetch("https://api.chongluadao.vn/v1/whitelist").then(e=>e.json()).then(e=>{e.forEach(e=>{r.push(e.url)})}).catch(()=>{})},c=(e,t,n)=>{const r={site:e,match:t,title:e,lenient:i,favicon:"https://www.google.com/s2/favicons?domain="+e};window.isBlocked[n]=e,browser.browserAction.setIcon({path:"../assets/cldvn_red.png",tabId:n});return{redirectUrl:`${browser.extension.getURL("blocking.html")}#${JSON.stringify(r)}`}},l=e=>{try{return new URL(e)}catch(e){return}},d=(e,t,n)=>{if(browser.browserAction.setTitle({title:`P:${e} per: ${t}`}),e)return browser.browserAction.setIcon({path:"../assets/cldvn_red.png",tabId:n});browser.browserAction.setIcon({path:"../assets/cldvn128.png",tabId:n})},u=e=>{const t=e.match(/^https?:\/\/([^/?#]+)(?:[/?#]|$)/i);return t&&t[1]};browser.runtime.onStartup.addListener(a),browser.runtime.onInstalled.addListener(()=>{a(),browser.notifications.create({type:"basic",iconUrl:browser.extension.getURL("assets/logo.png"),title:"Cài đặt thành công!",message:"Khởi động lại trình duyệt của bạn để có thể bắt đầu sử dụng ChongLuaDao. Xin cảm ơn!"})}),browser.tabs.onActivated.addListener((e=null)=>{if(e&&e.tabId)return d(window.isPhish[e.tabId],window.legitimatePercents[e.tabId],e.tabId);browser.tabs.query({active:!0,currentWindow:!0},([e])=>{d(window.isPhish[e.id],window.legitimatePercents[e.id],e.id)})}),browser.tabs.onUpdated.addListener((e,t,n)=>{"complete"==n.status&&browser.tabs.sendMessage(n.id,n)}),browser.runtime.onConnect.addListener(e=>{switch(e.name){case"REDIRECT_PORT_NAME":e.onMessage.addListener(e=>{browser.tabs.query({currentWindow:!0,active:!0},([t])=>{browser.tabs.update(t.id,{url:e.redirect})})});break;case"CLOSE_TAB_PORT_NAME":e.onMessage.addListener(e=>{e.close_tab&&browser.tabs.query({currentWindow:!0,active:!0},([e])=>{browser.tabs.remove(e.id)})});break;case"ML_PORT_NAME":e.onMessage.addListener(e=>{const{request:t}=e;void 0!==t.input_block_list&&(n=t.input_block_list,i=t.input_block_lenient),browser.tabs.query({currentWindow:!0,active:!0},([e])=>{window.results[e.id]=t,o(e.id,t,e.url)})})}}),browser.webRequest.onBeforeRequest.addListener(({url:e,tabId:t,initiator:i})=>{if(!e||0===e.indexOf("chrome://")||0===e.indexOf(browser.extension.getURL("/")))return;if(!n||!n.length)return;if(localStorage.getItem("whiteList"))return localStorage.removeItem("whiteList");const s=n,o=l(e),a=psl.parse(o.host),d=o.href.replaceAll("/","");for(let n=0;n<s.length;++n){const r=l(s[n]);if(!r)continue;const i=r.host.split(".")[0],u=r.pathname;if("%2A"==i){if(r.host.slice(4,r.host.length)==a.domain)return c(e,r.host,t)}if("/*"==u&&o.host===r.host)return c(e,r.host,t);if(d&&d==r.href.replaceAll("/",""))return c(e,r.host,t)}const h=u(i||e);r.find(e=>e.includes(h))&&(window.isWhiteList[t]=h)},{urls:["*://*/*"],types:["main_frame","sub_frame"]},["blocking"])}]);