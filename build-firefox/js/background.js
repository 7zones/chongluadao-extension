/*!

=========================================================
* Chong Lua Dao
=========================================================

* Product Page: https://chongluadao.vn/
* Copyright 2021 https://chongluadao.vn/
* Coded by ChongLuaDao

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

*/
!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t){window.isWhiteList={},window.isBlocked={},window.results={},window.isPhish={},window.legitimatePercents={};let r=[];const n=[];let i=!1;const o=e=>{browser.storage.local.get(["cache","cacheTime"],t=>{if(t.cache&&t.cacheTime)return e(t.cache);(e=>{fetch("https://api.chongluadao.vn/classifier.json").then(e=>e.json()).then(t=>{browser.storage.local.set({cache:t,cacheTime:Date.now()},()=>e(t))})})(e)})},s=(e,t,r)=>{if(window.isWhiteList[e]==r)return;let n=0,i=0,s=0;for(const e in t)"1"==t[e]?s++:"0"==t[e]?i++:n++;if(window.legitimatePercents[e]=n/(s+i+n)*100,t.length){const r=[t.map(e=>parseInt(e))];o((function(t){const n=(e=>({predict:t=>{let r=[e.estimators.map(e=>(e=>{const t=t=>{let r=e;for(;"split"==r.type;){const e=r.threshold.split(" <= ");r=t[e[0]]<=e[1]?r.left:r.right}return r.value[0]};return{predict:e=>e.map(e=>t(e)),predictOne:t}})(e).predict(t))];r=r[0].map((e,t)=>r.map(e=>e[t]));const n=[];for(const e in r){let t=0,i=0;for(const n in r[e])t+=r[e][n][1],i+=r[e][n][0];n.push([t>=i,Math.max(t,i)])}return n}}))(t);window.isPhish[e]=n.predict(r)[0][0],window.isPhish[e]&&window.legitimatePercents[e]>60&&(window.isPhish[e]=!1),d(window.isPhish[e],window.legitimatePercents[e],e)}))}},a=()=>{fetch("https://api.chongluadao.vn/v2/blacklist").then(e=>e.json()).then(e=>{e.forEach(e=>{r.push(e.url)})}).catch(()=>{}),fetch("https://api.chongluadao.vn/v2/whitelist").then(e=>e.json()).then(e=>{e.forEach(e=>{n.push(e.url)})}).catch(()=>{})},c=(e,t,r)=>{console.log("blockingFunction");const n={site:e,match:t,title:e,lenient:i,favicon:"https://www.google.com/s2/favicons?domain="+e};window.isBlocked[r]=e,browser.browserAction.setIcon({path:"../assets/cldvn_red.png",tabId:r});return{redirectUrl:`${browser.runtime.getURL("blocking.html")}#${JSON.stringify(n)}`}},l=e=>{try{return new URL(e.replace("*.",""))}catch(e){return}},d=(e,t,r)=>{if(browser.browserAction.setTitle({title:`P:${e} per: ${t}`}),e)return browser.browserAction.setIcon({path:"../assets/cldvn_red.png",tabId:r});browser.browserAction.setIcon({path:"../assets/cldvn128.png",tabId:r})},u=e=>{const t=e.match(/^https?:\/\/([^/?#]+)(?:[/?#]|$)/i);return t&&t[1]};browser.runtime.onStartup.addListener(a),browser.runtime.onInstalled.addListener(()=>{a(),browser.notifications.create({type:"basic",iconUrl:browser.runtime.getURL("assets/logo.png"),title:"Cài đặt thành công!",message:"Khởi động lại trình duyệt của bạn để có thể bắt đầu sử dụng ChongLuaDao. Xin cảm ơn!"})}),browser.tabs.onActivated.addListener((e=null)=>{if(e&&e.tabId)return d(window.isPhish[e.tabId],window.legitimatePercents[e.tabId],e.tabId);browser.tabs.query({active:!0,currentWindow:!0},([e])=>{d(window.isPhish[e.id],window.legitimatePercents[e.id],e.id)})}),browser.tabs.onUpdated.addListener((e,t,r)=>{"complete"==r.status&&browser.tabs.sendMessage(r.id,r)}),browser.runtime.onConnect.addListener(e=>{switch(e.name){case"REDIRECT_PORT_NAME":e.onMessage.addListener(e=>{browser.tabs.query({currentWindow:!0,active:!0},([t])=>{browser.tabs.update(t.id,{url:e.redirect})})});break;case"CLOSE_TAB_PORT_NAME":e.onMessage.addListener(e=>{e.close_tab&&browser.tabs.query({currentWindow:!0,active:!0},([e])=>{browser.tabs.remove(e.id)})});break;case"ML_PORT_NAME":e.onMessage.addListener(e=>{const{request:t}=e;void 0!==t.input_block_list&&(r=t.input_block_list,i=t.input_block_lenient),browser.tabs.query({currentWindow:!0,active:!0},([e])=>{window.results[e.id]=t,s(e.id,t,e.url)})})}}),browser.webRequest.onBeforeRequest.addListener(({url:e,tabId:t,initiator:i})=>{if(!e||0===e.indexOf("chrome://")||0===e.indexOf(browser.runtime.getURL("/")))return;if(!r||!r.length)return;if(localStorage.getItem("whiteList"))return localStorage.removeItem("whiteList");const o=r,s=l(e),a=psl.parse(s.host),d=s.href.replaceAll("/","");for(let r=0;r<o.length;++r){const n=l(o[r]);if(!n)continue;const i=o[r].indexOf("*."),u=n.pathname;if(i&&n.host===a.domain)return c(e,n.host,t);if("/*"==u&&s.host===n.host)return c(e,n.host,t);if(d&&d==n.href.replaceAll("/",""))return c(e,n.host,t)}const h=u(i||e);n.find(e=>e.includes(h))&&(window.isWhiteList[t]=h)},{urls:["*://*/*"],types:["main_frame","sub_frame"]},["blocking"])}]);